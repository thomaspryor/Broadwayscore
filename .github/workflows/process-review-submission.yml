name: Process Review Submission

on:
  issues:
    types: [opened, edited]

jobs:
  validate:
    # Only run on issues with the review-submission label
    if: contains(github.event.issue.labels.*.name, 'review-submission')
    runs-on: ubuntu-latest
    outputs:
      recommendation: ${{ steps.validate.outputs.recommendation }}
      show_id: ${{ steps.validate.outputs.show_id }}
      review_url: ${{ steps.validate.outputs.review_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Validate submission
        id: validate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          node scripts/validate-review-submission.js
        continue-on-error: true

      - name: Read validation comment
        id: read_comment
        run: |
          if [ -f .github-comment.md ]; then
            echo "comment_body<<EOF" >> $GITHUB_OUTPUT
            cat .github-comment.md >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Post validation result
        if: steps.read_comment.outputs.comment_body != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `${{ steps.read_comment.outputs.comment_body }}`
            });

      - name: Add label - Approved
        if: steps.validate.outputs.recommendation == 'approve'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['validated', 'approved']
            });
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'needs-validation'
            }).catch(() => {});

      - name: Add label - Rejected
        if: steps.validate.outputs.recommendation == 'reject'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['invalid']
            });
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'needs-validation'
            }).catch(() => {});
            // Close rejected issues
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });

      - name: Add label - Needs Manual Review
        if: steps.validate.outputs.recommendation == 'needs-manual-review'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['needs-manual-review']
            });

  scrape-review:
    needs: validate
    # Only run if validation passed
    if: needs.validate.outputs.recommendation == 'approve'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Scrape review
        id: scrape
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          BRIGHTDATA_TOKEN: ${{ secrets.BRIGHTDATA_TOKEN }}
          SCRAPINGBEE_API_KEY: ${{ secrets.SCRAPINGBEE_API_KEY }}
          NYT_EMAIL: ${{ secrets.NYT_EMAIL }}
          NYT_PASSWORD: ${{ secrets.NYT_PASSWORD }}
          VULTURE_EMAIL: ${{ secrets.VULTURE_EMAIL }}
          VULTURE_PASSWORD: ${{ secrets.VULTURE_PASSWORD }}
        run: |
          # Get show ID and review URL from validation output
          SHOW_ID="${{ needs.validate.outputs.show_id }}"
          REVIEW_URL="${{ needs.validate.outputs.review_url }}"

          if [ -z "$SHOW_ID" ] || [ -z "$REVIEW_URL" ]; then
            echo "Missing show_id or review_url from validation"
            exit 1
          fi

          # Run review collection for this specific URL
          node scripts/collect-review-texts-v2.js --show "$SHOW_ID" --url "$REVIEW_URL"

      - name: Commit and push changes
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/review-texts/
          git add data/reviews.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add review from submission #${{ github.event.issue.number }}"
            git push origin main
          fi

      - name: Post success comment
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ‚úÖ Review Successfully Added!

The review has been scraped and added to our database. It will appear on the site within a few minutes after the next deployment.

Thank you for your contribution to Broadway Scorecard! üé≠

---
*Added by automated system ‚Ä¢ ${new Date().toISOString()}*`
            });

            // Close the issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed',
              state_reason: 'completed'
            });

      - name: Post failure comment
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ‚ö†Ô∏è Scraping Failed

The review validation passed, but we encountered an error while scraping the review content.

A maintainer will investigate and manually add the review if possible.

---
*Error occurred at ${new Date().toISOString()}*`
            });

            // Add needs-manual-review label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['scraping-failed']
            });
