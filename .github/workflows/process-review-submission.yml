name: Process Review Submission

on:
  issues:
    types: [opened, edited]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'GitHub Issue number to process'
        required: true
        type: string

jobs:
  validate:
    # Run for workflow_dispatch (bridge trigger) or issues with review-submission label
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.issue.labels.*.name, 'review-submission')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      recommendation: ${{ steps.validate.outputs.recommendation }}
      show_id: ${{ steps.validate.outputs.show_id }}
      review_url: ${{ steps.validate.outputs.review_url }}
      issue_number: ${{ steps.resolve.outputs.issue_number }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Resolve issue context
        id: resolve
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ISSUE_NUM="${{ github.event.inputs.issue_number }}"
          else
            ISSUE_NUM="${{ github.event.issue.number }}"
          fi
          echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT

          # Fetch issue body from API (works for both trigger types)
          gh api "repos/${{ github.repository }}/issues/$ISSUE_NUM" --jq '.body' > .issue-body.txt
          echo "Resolved issue #$ISSUE_NUM"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Validate submission
        id: validate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          ISSUE_BODY="$(cat .issue-body.txt)" node scripts/validate-review-submission.js
        continue-on-error: true

      - name: Read validation comment
        id: read_comment
        run: |
          if [ -f .github-comment.md ]; then
            DELIM="COMMENT_BODY_$(date +%s)"
            echo "comment_body<<${DELIM}" >> $GITHUB_OUTPUT
            cat .github-comment.md >> $GITHUB_OUTPUT
            echo "${DELIM}" >> $GITHUB_OUTPUT
          fi

      - name: Post validation result
        if: steps.read_comment.outputs.comment_body != ''
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.resolve.outputs.issue_number }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `${{ steps.read_comment.outputs.comment_body }}`
            });

      - name: Add label - Approved
        if: steps.validate.outputs.recommendation == 'approve'
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.resolve.outputs.issue_number }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['validated', 'approved']
            });
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              name: 'needs-validation'
            }).catch(() => {});

      - name: Add label - Rejected
        if: steps.validate.outputs.recommendation == 'reject'
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.resolve.outputs.issue_number }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['invalid']
            });
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              name: 'needs-validation'
            }).catch(() => {});
            // Close rejected issues
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed'
            });

      - name: Add label - Needs Manual Review
        if: steps.validate.outputs.recommendation == 'needs-manual-review'
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.resolve.outputs.issue_number }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['needs-manual-review']
            });

  scrape-review:
    needs: validate
    # Only run if validation passed
    if: needs.validate.outputs.recommendation == 'approve'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Scrape review
        id: scrape
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          BRIGHTDATA_TOKEN: ${{ secrets.BRIGHTDATA_TOKEN }}
          SCRAPINGBEE_API_KEY: ${{ secrets.SCRAPINGBEE_API_KEY }}
          NYT_EMAIL: ${{ secrets.NYT_EMAIL }}
          NYT_PASSWORD: ${{ secrets.NYT_PASSWORD }}
          VULTURE_EMAIL: ${{ secrets.VULTURE_EMAIL }}
          VULTURE_PASSWORD: ${{ secrets.VULTURE_PASSWORD }}
        run: |
          # Get show ID and review URL from validation output
          SHOW_ID="${{ needs.validate.outputs.show_id }}"
          REVIEW_URL="${{ needs.validate.outputs.review_url }}"

          if [ -z "$SHOW_ID" ] || [ -z "$REVIEW_URL" ]; then
            echo "Missing show_id or review_url from validation"
            exit 1
          fi

          # Run review collection for this specific URL
          node scripts/collect-review-texts-v2.js --show "$SHOW_ID" --url "$REVIEW_URL"

      - name: Rebuild reviews.json
        if: success()
        run: node scripts/rebuild-all-reviews.js

      - name: Commit and push changes
        if: success()
        env:
          ISSUE_NUMBER: ${{ needs.validate.outputs.issue_number }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/review-texts/
          git add data/reviews.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add review from submission #${ISSUE_NUMBER}"
            # Push with robust retry logic
            MAX_RETRIES=5
            RETRY_COUNT=0
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              echo "Push attempt $((RETRY_COUNT + 1)) of $MAX_RETRIES"
              git checkout -- . 2>/dev/null || true
              git clean -fd 2>/dev/null || true
              if git pull --rebase -X theirs origin main; then
                if git push origin main; then
                  echo "Successfully pushed changes"
                  break
                fi
              else
                echo "Rebase failed, aborting and retrying..."
                git rebase --abort 2>/dev/null || true
              fi
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                WAIT_TIME=$((10 + RANDOM % 20))
                echo "Waiting $WAIT_TIME seconds before retry..."
                sleep $WAIT_TIME
                git fetch origin main
              fi
            done
          fi

      - name: Post success comment
        if: success()
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ needs.validate.outputs.issue_number }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            const now = new Date().toISOString();
            const body = '## ‚úÖ Review Successfully Added!\n\n' +
              'The review has been scraped and added to our database. ' +
              'It will appear on the site within a few minutes after the next deployment.\n\n' +
              'Thank you for your contribution to Broadway Scorecard! üé≠\n\n' +
              '---\n' +
              '*Added by automated system ‚Ä¢ ' + now + '*';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: body
            });

            // Close the issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed',
              state_reason: 'completed'
            });

      - name: Post failure comment
        if: failure()
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ needs.validate.outputs.issue_number }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            const now = new Date().toISOString();
            const body = '## ‚ö†Ô∏è Scraping Failed\n\n' +
              'The review validation passed, but we encountered an error while scraping the review content.\n\n' +
              'A maintainer will investigate and manually add the review if possible.\n\n' +
              '---\n' +
              '*Error occurred at ' + now + '*';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: body
            });

            // Add needs-manual-review label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['scraping-failed']
            });
