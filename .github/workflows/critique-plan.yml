name: Critique Plan with Multiple LLMs

on:
  workflow_dispatch:

jobs:
  critique:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Critique with OpenAI GPT-4o
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          node << 'EOF'
          const fs = require('fs');

          async function critique() {
            const plan = fs.readFileSync('docs/plans/data-governance-v2.md', 'utf8');

            const prompt = `You are a senior software architect reviewing a data governance plan for a Broadway review aggregation site. Be HIGHLY CRITICAL and thorough. Find problems.

CONTEXT: The site has severe data quality issues:
- 141 duplicate critics (same review counted twice with different scores)
- 48 reviews with "unknown" outlet
- 24 outlets showing raw IDs instead of proper names ("latimes" instead of "Los Angeles Times")
- 300 reviews with null publish dates
- Critic name variations causing duplicates ("Chris Jones" vs "Chris")

YOUR TASK: Critique this plan ruthlessly. Identify:
1. **Gaps** - What critical things are missing?
2. **Risks** - What could go wrong during execution?
3. **Over-engineering** - Is anything unnecessarily complex? Could it be simpler?
4. **Sequencing issues** - Are phases in the right order? Dependencies correct?
5. **Timeline realism** - Is 5 days realistic for this scope?
6. **Alternative approaches** - Are there fundamentally better/simpler solutions?
7. **Blind spots** - What hasn't been considered?

Be specific and actionable. Don't validate - find problems.

THE PLAN TO CRITIQUE:
${plan}`;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': \`Bearer \${process.env.OPENAI_API_KEY}\`
              },
              body: JSON.stringify({
                model: 'gpt-4o',
                messages: [{ role: 'user', content: prompt }],
                max_tokens: 4000,
                temperature: 0.7
              })
            });

            const data = await response.json();
            if (data.error) {
              console.error('OpenAI Error:', JSON.stringify(data.error));
              process.exit(1);
            }
            console.log('=== OPENAI GPT-4o CRITIQUE ===\n');
            console.log(data.choices[0].message.content);
          }

          critique().catch(e => { console.error(e); process.exit(1); });
          EOF

      - name: Critique with Google Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          node << 'EOF'
          const fs = require('fs');

          async function critique() {
            const plan = fs.readFileSync('docs/plans/data-governance-v2.md', 'utf8');

            const prompt = `You are a senior software architect reviewing a data governance plan for a Broadway review aggregation site. Be HIGHLY CRITICAL and thorough. Find problems.

CONTEXT: The site has severe data quality issues:
- 141 duplicate critics (same review counted twice with different scores)
- 48 reviews with "unknown" outlet
- 24 outlets showing raw IDs instead of proper names
- 300 reviews with null publish dates
- Critic name variations causing duplicates

YOUR TASK: Critique this plan ruthlessly. Identify:
1. **Gaps** - What critical things are missing?
2. **Risks** - What could go wrong during execution?
3. **Over-engineering** - Is anything unnecessarily complex?
4. **Sequencing issues** - Are phases in the right order?
5. **Timeline realism** - Is 5 days realistic?
6. **Alternative approaches** - Are there simpler solutions?
7. **Blind spots** - What hasn't been considered?

Be specific and actionable. Don't validate - find problems.

THE PLAN TO CRITIQUE:
${plan}`;

            const apiKey = process.env.GEMINI_API_KEY;
            if (!apiKey) {
              console.log('=== GOOGLE GEMINI CRITIQUE ===\n');
              console.log('SKIPPED: No GEMINI_API_KEY secret configured');
              return;
            }

            const response = await fetch(\`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=\${apiKey}\`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { maxOutputTokens: 4000, temperature: 0.7 }
              })
            });

            const data = await response.json();
            console.log('=== GOOGLE GEMINI CRITIQUE ===\n');
            if (data.error) {
              console.error('Gemini Error:', JSON.stringify(data.error));
            } else {
              console.log(data.candidates?.[0]?.content?.parts?.[0]?.text || 'No response');
            }
          }

          critique().catch(e => { console.error(e); process.exit(1); });
          EOF
