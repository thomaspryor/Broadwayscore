name: Monthly Scoring Audit

on:
  schedule:
    - cron: '0 5 1 * *'  # 1st of month, 5 AM UTC
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  scoring-audit:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Rebuild reviews.json
        run: node scripts/rebuild-all-reviews.js
        env:
          ALLOW_DRIFT: 'true'

      - name: Generate scoring audit
        id: audit
        run: |
          node scripts/generate-scoring-audit.js
          echo "flagged=$(cat data/audit/scoring-audit.json | jq '.flags.total')" >> $GITHUB_OUTPUT
          echo "flag_pct=$(cat data/audit/scoring-audit.json | jq '.flagPctOfTotal')" >> $GITHUB_OUTPUT
          echo "total=$(cat data/audit/scoring-audit.json | jq '.summary.totalReviews')" >> $GITHUB_OUTPUT
          echo "high_delta=$(cat data/audit/scoring-audit.json | jq '.scoringIssues.highDeltaCount')" >> $GITHUB_OUTPUT
          echo "exceeds=$(cat data/audit/scoring-audit.json | jq '.exceedsThreshold')" >> $GITHUB_OUTPUT

      - name: Commit audit data
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/audit/scoring-audit.json data/audit/scoring-audit.md data/audit/scoring-audit-history.json data/audit/needs-human-review.json data/audit/rebuild-score-drift.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "audit: Monthly scoring audit $(date +%Y-%m-%d)"
            git push origin main
          fi

      - name: Create GitHub issue with audit digest
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('data/audit/scoring-audit.md', 'utf8');
            const flagged = parseInt('${{ steps.audit.outputs.flagged }}') || 0;
            const exceeds = '${{ steps.audit.outputs.exceeds }}' === 'true';

            const title = `Scoring Audit — ${new Date().toISOString().split('T')[0]}${exceeds ? ' ⚠️ THRESHOLD EXCEEDED' : ''}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: report,
              labels: ['scoring-audit', 'automated']
            });
