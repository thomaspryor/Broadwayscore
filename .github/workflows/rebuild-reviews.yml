# Rebuild reviews.json from review-texts source files
# This is the PRIMARY sync mechanism - runs daily and can be triggered manually
name: Rebuild Reviews Data

on:
  schedule:
    # Daily at 4 AM UTC (11 PM EST) - after other workflows typically complete
    - cron: '0 4 * * *'
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual rebuild (for commit message)'
        required: false
        default: 'Manual sync'
        type: string
      allow_drift:
        description: 'Allow large score drift (e.g. after prompt version rescore)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  rebuild:
    name: Rebuild reviews.json
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get current review count
        id: before
        run: |
          if [ -f data/reviews.json ]; then
            COUNT=$(node -e "console.log(require('./data/reviews.json').reviews.length)")
            echo "count=$COUNT" >> $GITHUB_OUTPUT
          else
            echo "count=0" >> $GITHUB_OUTPUT
          fi

      - name: Rebuild reviews.json
        env:
          ALLOW_DRIFT: ${{ github.event.inputs.allow_drift }}
        run: node scripts/rebuild-all-reviews.js

      - name: Update critic registry
        run: node scripts/audit-critic-outlets.js
        continue-on-error: true

      - name: Get new review count
        id: after
        run: |
          COUNT=$(node -e "console.log(require('./data/reviews.json').reviews.length)")
          echo "count=$COUNT" >> $GITHUB_OUTPUT

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet data/reviews.json; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes to reviews.json"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in reviews.json"
            git diff --stat data/reviews.json
          fi

      - name: Check for large files
        if: steps.changes.outputs.has_changes == 'true'
        uses: ./.github/actions/check-file-sizes

      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add data/reviews.json
          git add data/critic-registry.json data/audit/critic-outlet-affinity.json 2>/dev/null || true

          BEFORE=${{ steps.before.outputs.count }}
          AFTER=${{ steps.after.outputs.count }}
          DIFF=$((AFTER - BEFORE))

          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            REASON="${{ inputs.reason }}"
            MSG="data: Rebuild reviews.json - $REASON"
          else
            MSG="data: Scheduled rebuild of reviews.json"
          fi

          if [ $DIFF -ne 0 ]; then
            if [ $DIFF -gt 0 ]; then
              MSG="$MSG (+$DIFF reviews)"
            else
              MSG="$MSG ($DIFF reviews)"
            fi
          fi

          git commit -m "$MSG

          Reviews: $BEFORE â†’ $AFTER

          Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

          # Retry push with rebase in case of concurrent changes
          for i in 1 2 3 4 5; do
            if git push origin main; then
              echo "Push succeeded on attempt $i"
              break
            fi
            echo "Push failed (attempt $i), pulling and rebasing..."
            git checkout -- . 2>/dev/null || true
            git clean -fd 2>/dev/null || true
            git pull --rebase -X theirs origin main || { git rebase --abort 2>/dev/null || true; }
            sleep $((RANDOM % 5 + 2))
          done

      - name: Auto-trigger LLM scoring if needed
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Count reviews needing LLM scoring (have scorable text, no score)
          UNSCORED=$(node -e '
            const fs = require("fs");
            const path = require("path");
            const base = "data/review-texts";
            let n = 0;
            const dirs = fs.readdirSync(base).filter(d => {
              try { return fs.statSync(path.join(base, d)).isDirectory(); } catch { return false; }
            });
            dirs.forEach(d => {
              const showDir = path.join(base, d);
              fs.readdirSync(showDir).filter(f => f.endsWith(".json") && f !== "failed-fetches.json").forEach(f => {
                try {
                  const r = JSON.parse(fs.readFileSync(path.join(showDir, f), "utf8"));
                  if (r.wrongProduction || r.wrongShow || r.wrongAttribution) return;
                  const ct = r.contentTier || "";
                  const hasText = r.fullText && r.fullText.length > 100;
                  const scorable = ["complete", "truncated", "stub"].includes(ct);
                  const needsScore = !r.assignedScore && !r.humanReviewScore;
                  const needsRescore = !!r.rescoreReason;
                  if ((hasText || scorable) && (needsScore || needsRescore)) n++;
                } catch {}
              });
            });
            console.log(n);
          ')

          echo "Reviews needing LLM scoring: $UNSCORED"

          THRESHOLD=100
          if [ "$UNSCORED" -lt "$THRESHOLD" ]; then
            echo "Below threshold ($THRESHOLD). Skipping auto-trigger."
            exit 0
          fi

          # Check if LLM scoring is already running
          RUNNING=$(gh run list --workflow="LLM Ensemble Score Reviews" --status=in_progress --json databaseId --jq 'length' 2>/dev/null || echo "0")
          if [ "$RUNNING" -gt 0 ]; then
            echo "LLM scoring already running ($RUNNING active runs). Skipping."
            exit 0
          fi

          # Cap batch at 400 (safe under 6-hour timeout)
          LIMIT=400
          if [ "$UNSCORED" -lt "$LIMIT" ]; then
            LIMIT=$UNSCORED
          fi

          echo "Triggering LLM scoring for $UNSCORED reviews (limit=$LIMIT)..."
          gh workflow run "LLM Ensemble Score Reviews" \
            -f limit=$LIMIT \
            -f run_calibration=false

          echo "LLM scoring auto-triggered successfully."

      - name: Summary
        run: |
          echo "## Reviews Rebuild Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Before:** ${{ steps.before.outputs.count }} reviews" >> $GITHUB_STEP_SUMMARY
          echo "**After:** ${{ steps.after.outputs.count }} reviews" >> $GITHUB_STEP_SUMMARY
          echo "**Changes:** ${{ steps.changes.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "**Trigger:** Manual (${{ inputs.reason }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Trigger:** Scheduled (daily 4 AM UTC)" >> $GITHUB_STEP_SUMMARY
          fi
